# Cafe Onboarding System Implementation

## Обзор

Реализована комплексная система онбординга кафе, позволяющая владельцам кафе подавать заявки на подключение к платформе через iOS приложение. Администраторы могут просматривать, одобрять или отклонять заявки через admin panel.

## Компоненты системы

### 1. Backend (Supabase Migration)

**Файл:** `supabase/migrations/20260202000000_cafe_onboarding.sql`

#### Таблицы:

**cafe_onboarding_requests**
- Хранит заявки на подключение кафе
- Поля: cafe_name, cafe_address, cafe_phone, cafe_email, cafe_description, business_type, opening_hours, estimated_daily_orders
- Статусы: pending, under_review, approved, rejected, cancelled
- Связи: applicant_user_id → auth.users, created_cafe_id → cafes

**cafe_documents**
- Хранит документы, загруженные с заявкой (логотипы, фото, лицензии)
- Типы документов: logo, menu_photo, interior_photo, business_license, other
- Связь: request_id → cafe_onboarding_requests

#### RPC Функции:

1. **submit_cafe_application** - Подача заявки пользователем
   - Параметры: cafe_name, cafe_address, cafe_phone, cafe_email, description, business_type, opening_hours, estimated_daily_orders
   - Возвращает: UUID заявки
   - Валидация всех обязательных полей

2. **approve_cafe** - Одобрение заявки (только admin)
   - Создает новое кафе в таблице cafes
   - Присваивает роль 'owner' заявителю
   - Обновляет статус заявки на 'approved'
   - Параметры: request_id, review_comment

3. **reject_cafe** - Отклонение заявки (только admin)
   - Параметры: request_id, rejection_reason
   - Обновляет статус заявки на 'rejected'

4. **get_onboarding_requests** - Получить все заявки с фильтрацией (только admin)
   - Параметры: status (optional), limit, offset
   - Возвращает список заявок с информацией о заявителе и reviewer

5. **get_my_onboarding_requests** - Получить свои заявки (для пользователя)
   - Возвращает список заявок текущего пользователя

6. **cancel_onboarding_request** - Отменить свою заявку
   - Параметры: request_id
   - Может отменить только pending заявки

#### Row Level Security (RLS):

- Пользователи могут просматривать и редактировать только свои заявки
- Администраторы имеют полный доступ ко всем заявкам
- Документы доступны владельцу заявки и администраторам

### 2. iOS App

#### Models

**Файл:** `Models/CafeOnboardingModels.swift`

Модели данных:
- `CafeOnboardingStatus` - enum со статусами заявок
- `CafeBusinessType` - enum с типами бизнеса (independent, franchise, chain)
- `CafeDocumentType` - enum с типами документов
- `CafeOnboardingRequest` - основная модель заявки
- `CafeOnboardingSubmission` - модель для отправки новой заявки
- `CafeDocument` - модель документа

#### Service

**Файл:** `Helpers/CafeOnboardingService.swift`

API клиент для работы с системой онбординга:
- `submitApplication()` - отправка новой заявки
- `getMyRequests()` - получение списка своих заявок
- `cancelRequest()` - отмена заявки

Также добавлено расширение `SupabaseAPIClient` с поддержкой кастомного JSONDecoder для RPC вызовов.

#### Views

**CafeOnboardingFormView.swift**
- Форма для подачи заявки на подключение кафе
- Валидация всех обязательных полей
- Отображение ошибок и индикаторов загрузки
- Success alert после успешной отправки

**CafeOnboardingListView.swift**
- Список всех заявок пользователя
- Pull-to-refresh для обновления
- Empty state с призывом создать заявку
- Навигация к детальному просмотру заявки

**CafeOnboardingDetailView.swift**
- Детальная информация о заявке
- Отображение статуса с соответствующими иконками и цветами
- Информация о кафе и бизнесе
- Комментарии reviewer (для approved)
- Причины отклонения (для rejected)
- Возможность отменить pending заявку

**ProfileView.swift** (обновлен)
- Добавлена новая секция "Для владельцев кафе"
- Кнопка "Подать заявку на подключение"
- Открывает CafeOnboardingListView

## Использование

### Для пользователей (владельцев кафе):

1. Открыть раздел "Профиль" в приложении
2. Найти секцию "Для владельцев кафе"
3. Нажать "Подать заявку на подключение"
4. Заполнить форму с информацией о кафе:
   - Название кафе (обязательно)
   - Адрес (обязательно)
   - Телефон (обязательно)
   - Email (обязательно)
   - Тип бизнеса (опционально)
   - Часы работы (опционально)
   - Ожидаемое количество заказов в день (опционально)
   - Описание кафе (опционально)
5. Нажать "Отправить"
6. Отслеживать статус заявки в списке заявок

### Для администраторов:

Функционал admin panel будет реализован отдельно. Базовые RPC функции уже готовы:
- `get_onboarding_requests()` - получить все заявки
- `approve_cafe()` - одобрить заявку
- `reject_cafe()` - отклонить заявку

## Статусы заявок

1. **pending** - Заявка подана, ожидает рассмотрения
2. **under_review** - Заявка на рассмотрении
3. **approved** - Заявка одобрена, кафе создано
4. **rejected** - Заявка отклонена
5. **cancelled** - Заявка отменена пользователем

## Workflow

```
Пользователь → Подать заявку (pending)
                    ↓
Админ → Рассмотреть (under_review)
                    ↓
         [Одобрить] или [Отклонить]
              ↓              ↓
         (approved)      (rejected)
              ↓
    Создание кафе + роль owner для пользователя
```

## Безопасность

- Все RPC функции проверяют аутентификацию пользователя
- Административные функции доступны только пользователям с ролью 'admin'
- RLS политики защищают данные от несанкционированного доступа
- Валидация всех входных данных на уровне SQL

## Будущие улучшения

1. **Загрузка документов**
   - Интеграция с Supabase Storage
   - Поддержка загрузки фото и документов
   - Предпросмотр документов в детальном view

2. **Admin Panel**
   - Страницы для просмотра и управления заявками
   - Email уведомления владельцам при изменении статуса
   - Массовые операции над заявками

3. **Расширенная валидация**
   - Проверка уникальности адреса/телефона
   - Валидация email и телефона
   - Проверка дубликатов заявок

4. **Аналитика**
   - Dashboard с метриками онбординга
   - Время обработки заявок
   - Conversion rate (approved/total)

## Тестирование

### Ручное тестирование:

1. Создать новую заявку через iOS app
2. Проверить, что заявка появляется в списке со статусом "pending"
3. Через admin RPC одобрить заявку
4. Проверить, что создано кафе и пользователю присвоена роль 'owner'
5. Проверить отклонение заявки с причиной
6. Проверить отмену pending заявки пользователем

### SQL тесты:

Рекомендуется добавить тесты в `SubscribeCoffieBackend/tests/`:
- Тест создания заявки
- Тест одобрения и создания кафе
- Тест RLS политик
- Тест валидации

## Зависимости

- Требуется миграция `20260126123500_profiles_owner_role.sql` (для роли 'owner')
- Требуется функция `public.is_admin()` из более ранних миграций
- Требует работающую аутентификацию в iOS app

## Changelog

### 2026-02-02
- ✅ Создана миграция с таблицами и RPC функциями
- ✅ Реализованы iOS модели
- ✅ Создан CafeOnboardingService
- ✅ Реализованы UI экраны (Form, List, Detail)
- ✅ Интегрировано в ProfileView

## Авторы

Реализовано в соответствии с планом развития SubscribeCoffie (раздел 1.2 - Онбординг кафе)
